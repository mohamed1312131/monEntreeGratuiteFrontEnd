<div class="editor-container">
  <div *ngIf="loading" class="loading-overlay">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading template...</p>
  </div>

  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>{{ templateId ? 'edit' : 'add' }}</mat-icon>
        {{ templateId ? 'Edit Template' : 'Create New Template' }} (Simplified Builder)
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="header-actions">
        <button mat-raised-button (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
          Back to List
        </button>
        <button mat-raised-button color="primary" (click)="saveTemplate()" 
                [disabled]="saving || templateForm.invalid">
          <mat-icon>{{ saving ? 'hourglass_empty' : 'save' }}</mat-icon>
          {{ saving ? 'Saving...' : (templateId ? 'Update' : 'Create') }}
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <form [formGroup]="templateForm" class="template-form">
    <div class="form-layout">
      <!-- Left Column: Configuration -->
      <div class="left-column">
        
        <!-- Basic Info -->
        <mat-card class="form-card">
          <mat-card-content>
            <h3>Basic Information</h3>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Template Name</mat-label>
              <input matInput formControlName="name" placeholder="e.g., Event Invitation">
              <mat-icon matSuffix>label</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Email Subject</mat-label>
              <input matInput formControlName="subject" placeholder="e.g., You're Invited!">
              <mat-icon matSuffix>subject</mat-icon>
              <mat-hint>Can include dynamic fields like {{'{{'}}NOM{{'}}'}}</mat-hint>
            </mat-form-field>

            <div class="toggle-field">
              <mat-slide-toggle formControlName="isActive" color="primary">
                Active Template
              </mat-slide-toggle>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Styling -->
        <mat-card class="form-card">
          <mat-card-content>
            <h3>Global Styling</h3>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Background Color</mat-label>
              <input matInput formControlName="backgroundColor" type="color">
              <mat-icon matSuffix>palette</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Primary Color</mat-label>
              <input matInput formControlName="primaryColor" type="color">
              <mat-icon matSuffix>palette</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Font Family</mat-label>
              <mat-select formControlName="fontFamily">
                <mat-option *ngFor="let font of fontFamilies" [value]="font.value">
                  {{ font.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Font Size</mat-label>
              <mat-select formControlName="fontSize">
                <mat-option *ngFor="let size of fontSizes" [value]="size.value">
                  {{ size.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- Header Image -->
        <mat-card class="form-card">
          <mat-card-content>
            <h3>Header Image (Full Width)</h3>
            
            <input type="file" 
                   #headerFileInput 
                   accept="image/*" 
                   (change)="onHeaderImageSelected($event)"
                   style="display: none;">
            
            <button mat-raised-button 
                    type="button"
                    (click)="headerFileInput.click()" 
                    [disabled]="uploadingHeader"
                    color="primary">
              <mat-icon>{{ uploadingHeader ? 'hourglass_empty' : 'cloud_upload' }}</mat-icon>
              {{ uploadingHeader ? 'Uploading...' : 'Upload Header Image' }}
            </button>

            <div *ngIf="headerImagePreview" class="image-preview">
              <img [src]="headerImagePreview" alt="Header Preview">
              <button mat-icon-button 
                      (click)="removeHeaderImage()" 
                      color="warn"
                      class="remove-image-btn"
                      matTooltip="Remove image">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Content Section -->
        <mat-card class="form-card">
          <mat-card-content>
            <h3>Email Content</h3>
            <p class="section-hint">Write your content and insert dynamic fields by typing them correctly (e.g., {{'{{'}}NOM{{'}}'}}, {{'{{'}}DATE{{'}}'}}). Line breaks will be preserved.</p>

            <div class="dynamic-fields-chips">
              <p style="font-size: 13px; color: #666; margin-bottom: 8px;">Click to insert dynamic fields:</p>
              <mat-chip-set>
                <mat-chip *ngFor="let field of availableDynamicFieldsForChips" 
                          (click)="insertDynamicField(field.key)"
                          style="cursor: pointer;">
                  <mat-icon>add</mat-icon>
                  {{field.label}}
                </mat-chip>
              </mat-chip-set>
            </div>

            <mat-form-field appearance="outline" class="full-width" style="margin-top: 16px;">
              <mat-label>Email Content</mat-label>
              <textarea matInput formControlName="contentText" rows="10"
                        placeholder="Example:
Bonjour {{'{{'}}NOM{{'}}'}},

Votre réservation pour le {{'{{'}}DATE{{'}}'}} à {{'{{'}}HEURE{{'}}'}} est confirmée.
Code de réservation: {{'{{'}}CODE{{'}}'}}

À bientôt!"></textarea>
              <mat-hint>Use dynamic fields like {{'{{'}}NOM{{'}}'}}, {{'{{'}}DATE{{'}}'}}, {{'{{'}}HEURE{{'}}'}}, {{'{{'}}CODE{{'}}'}}, {{'{{'}}FOIRE_NAME{{'}}'}}</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Content Text Color</mat-label>
              <input matInput formControlName="contentTextColor" type="color">
              <mat-icon matSuffix>palette</mat-icon>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- Button -->
        <mat-card class="form-card">
          <mat-card-content>
            <h3>Call-to-Action Button</h3>

            <div class="toggle-field">
              <mat-slide-toggle formControlName="buttonEnabled" color="primary">
                Include Button
              </mat-slide-toggle>
            </div>

            <div *ngIf="templateForm.get('buttonEnabled')?.value">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Button Text</mat-label>
                <input matInput formControlName="buttonText" placeholder="e.g., Register Now">
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Button Link</mat-label>
                <input matInput formControlName="buttonLink" placeholder="https://...">
              </mat-form-field>

              <div class="color-row">
                <mat-form-field appearance="outline">
                  <mat-label>Background Color</mat-label>
                  <input matInput formControlName="buttonBgColor" type="color">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Text Color</mat-label>
                  <input matInput formControlName="buttonTextColor" type="color">
                </mat-form-field>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- GPS Coordinates -->
        <mat-card class="form-card">
          <mat-card-content>
            <h3>GPS Coordinates</h3>

            <div class="toggle-field">
              <mat-slide-toggle formControlName="gpsEnabled" color="primary">
                Include GPS Section
              </mat-slide-toggle>
            </div>

            <div *ngIf="templateForm.get('gpsEnabled')?.value">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Section Label</mat-label>
                <input matInput formControlName="gpsLabel" placeholder="COORDONNÉES GPS">
              </mat-form-field>

              <div class="color-row">
                <mat-form-field appearance="outline">
                  <mat-label>Latitude</mat-label>
                  <input matInput formControlName="gpsLatitude" placeholder="48.8566">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Longitude</mat-label>
                  <input matInput formControlName="gpsLongitude" placeholder="2.3522">
                </mat-form-field>
              </div>

              <h4 style="margin: 16px 0 8px 0; font-size: 14px; font-weight: 600;">GPS Section Colors</h4>
              
              <div class="color-row">
                <mat-form-field appearance="outline">
                  <mat-label>Background Color</mat-label>
                  <input matInput formControlName="gpsBgColor" type="color">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Text Color</mat-label>
                  <input matInput formControlName="gpsTextColor" type="color">
                </mat-form-field>
              </div>

              <div class="color-row">
                <mat-form-field appearance="outline">
                  <mat-label>Button Background</mat-label>
                  <input matInput formControlName="gpsButtonBgColor" type="color">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Button Text Color</mat-label>
                  <input matInput formControlName="gpsButtonTextColor" type="color">
                </mat-form-field>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Gallery Images -->
        <mat-card class="form-card">
          <mat-card-content>
            <h3>Image Gallery</h3>
            
            <input type="file" 
                   #galleryFileInput 
                   accept="image/*" 
                   multiple
                   (change)="onGalleryImagesSelected($event)"
                   style="display: none;">
            
            <button mat-raised-button 
                    type="button"
                    (click)="galleryFileInput.click()" 
                    [disabled]="uploadingGallery"
                    color="primary">
              <mat-icon>{{ uploadingGallery ? 'hourglass_empty' : 'add_photo_alternate' }}</mat-icon>
              {{ uploadingGallery ? 'Uploading...' : 'Upload Gallery Images' }}
            </button>
            <p class="section-hint">Images will display vertically in the email. Drag to reorder.</p>

            <div *ngIf="galleryPreviews.length > 0" 
                 class="gallery-preview-vertical"
                 cdkDropList
                 (cdkDropListDropped)="onGalleryDrop($event)">
              <div *ngFor="let url of galleryPreviews; let i = index" 
                   class="gallery-item-vertical"
                   cdkDrag>
                <div class="drag-handle" cdkDragHandle>
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                <img [src]="url" alt="Gallery Image {{i + 1}}">
                <div class="gallery-item-info">
                  <span class="image-order">Image {{i + 1}}</span>
                  <button mat-icon-button 
                          (click)="removeGalleryImage(i)" 
                          color="warn"
                          matTooltip="Remove image">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Footer Options -->
        <mat-card class="form-card">
          <mat-card-content>
            <h3>Footer Options</h3>

            <div class="checkbox-field">
              <mat-checkbox formControlName="includeSocialLinks">
                Include Social Links (from settings)
              </mat-checkbox>
            </div>

            <div class="checkbox-field">
              <mat-checkbox formControlName="includeUnsubscribe" [disabled]="true">
                Include Unsubscribe Link (Required)
              </mat-checkbox>
            </div>
          </mat-card-content>
        </mat-card>

      </div>

      <!-- Right Column: Preview -->
      <div class="right-column">
        <mat-card class="preview-card sticky">
          <mat-card-content>
            <h3>Live Preview</h3>
            <p class="preview-hint">Dynamic fields show sample data</p>
            
            <div class="email-preview-wrapper">
              <div class="email-preview" [innerHTML]="getPreviewHtml()"></div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  </form>
</div>
