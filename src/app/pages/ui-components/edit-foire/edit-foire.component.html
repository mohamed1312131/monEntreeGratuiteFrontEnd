<div class="dialog-container">
  <h2 mat-dialog-title class="dialog-title">
    <mat-icon class="title-icon">edit</mat-icon>
    Modifier la foire - {{ data.countryName }}
  </h2>

  <mat-dialog-content class="dialog-content">
    <form [formGroup]="form" class="foire-form" autocomplete="off">
      
      <!-- Foire Name -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Nom de la foire</mat-label>
        <input matInput formControlName="nomFoire" placeholder="Ex: Salon de l'Agriculture 2025" />
        <mat-icon matPrefix>label</mat-icon>
        <mat-error *ngIf="form.get('nomFoire')?.hasError('required')">
          Le nom est requis
        </mat-error>
      </mat-form-field>

      <!-- Location -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Lieu de la foire</mat-label>
        <input matInput formControlName="location" placeholder="Ex: Paris, France" />
        <mat-icon matPrefix>location_on</mat-icon>
        <mat-error *ngIf="form.get('location')?.hasError('required')">
          Le lieu est requis
        </mat-error>
      </mat-form-field>

      <!-- Date Ranges Section -->
      <div class="date-ranges-section">
        <div class="section-header">
          <label class="section-label">
            <mat-icon>date_range</mat-icon>
            Périodes de la foire
          </label>
          <button mat-icon-button type="button" (click)="addDateRange()" class="add-range-btn" matTooltip="Ajouter une période">
            <mat-icon>add_circle</mat-icon>
          </button>
        </div>

        <div *ngFor="let range of dateRanges; let i = index" class="date-range-card">
          <div class="card-header">
            <span class="period-number">Période {{ i + 1 }}</span>
            <button 
              mat-icon-button 
              type="button" 
              (click)="removeDateRange(i)" 
              class="remove-range-btn"
              [disabled]="dateRanges.length === 1"
              matTooltip="Supprimer cette période">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="date-time-grid">
            <!-- Start Date & Time -->
            <div class="datetime-group">
              <label class="group-label">
                <mat-icon>event</mat-icon>
                Début
              </label>
              <div class="fields-row">
                <mat-form-field appearance="outline" class="date-field">
                  <mat-label>Date</mat-label>
                  <input matInput type="date" [(ngModel)]="range.startDate" [ngModelOptions]="{standalone: true}" required />
                  <mat-icon matPrefix>calendar_today</mat-icon>
                </mat-form-field>
                <mat-form-field appearance="outline" class="time-field">
                  <mat-label>Heure (optionnel)</mat-label>
                  <input matInput type="time" [(ngModel)]="range.startTime" [ngModelOptions]="{standalone: true}" placeholder="HH:mm" />
                  <mat-icon matPrefix>schedule</mat-icon>
                </mat-form-field>
              </div>
            </div>

            <!-- End Date & Time -->
            <div class="datetime-group">
              <label class="group-label">
                <mat-icon>event</mat-icon>
                Fin
              </label>
              <div class="fields-row">
                <mat-form-field appearance="outline" class="date-field">
                  <mat-label>Date</mat-label>
                  <input matInput type="date" [(ngModel)]="range.endDate" [ngModelOptions]="{standalone: true}" required />
                  <mat-icon matPrefix>calendar_today</mat-icon>
                </mat-form-field>
                <mat-form-field appearance="outline" class="time-field">
                  <mat-label>Heure (optionnel)</mat-label>
                  <input matInput type="time" [(ngModel)]="range.endTime" [ngModelOptions]="{standalone: true}" placeholder="HH:mm" />
                  <mat-icon matPrefix>schedule</mat-icon>
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Description -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Description</mat-label>
        <textarea
          matInput
          formControlName="description"
          rows="4"
          placeholder="Décrivez la foire..."
        ></textarea>
        <mat-icon matPrefix>description</mat-icon>
        <mat-error *ngIf="form.get('description')?.hasError('required')">
          La description est requise
        </mat-error>
      </mat-form-field>

      <!-- Image Upload -->
      <div class="image-upload-section">
        <label class="upload-label">
          <mat-icon>cloud_upload</mat-icon>
          Image de la foire
        </label>
        
        <!-- Current Image Preview -->
        <div class="current-image-preview" *ngIf="currentImage && !selectedFile">
          <img [src]="currentImage" alt="Current image" class="preview-img" />
          <p class="preview-text">Image actuelle (cliquez ci-dessous pour changer)</p>
        </div>

        <div class="upload-area" (click)="fileInput.click()">
          <input
            #fileInput
            type="file"
            accept="image/*"
            (change)="onFileChange($event)"
            hidden
          />
          <div class="upload-content" *ngIf="!selectedFile">
            <mat-icon class="upload-icon">add_photo_alternate</mat-icon>
            <p class="upload-text">Cliquez pour {{ currentImage ? 'changer' : 'sélectionner' }} l'image</p>
            <p class="upload-hint">PNG, JPG, JPEG, GIF (Max 5MB)</p>
          </div>
          <div class="upload-preview" *ngIf="selectedFile">
            <mat-icon class="check-icon">check_circle</mat-icon>
            <p class="file-name">{{ selectedFile.name }}</p>
            <button
              mat-icon-button
              type="button"
              (click)="removeImage($event)"
              class="remove-btn"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
        <mat-error *ngIf="imageError" class="error-text">
          Veuillez sélectionner une image valide
        </mat-error>
      </div>

    </form>
  </mat-dialog-content>

  <mat-dialog-actions class="dialog-actions">
    <button mat-button (click)="close()" class="cancel-btn">
      <mat-icon>close</mat-icon>
      Annuler
    </button>
    <button
      mat-raised-button
      color="primary"
      (click)="submit()"
      [disabled]="form.invalid || isSubmitting"
      class="submit-btn"
    >
      <mat-icon *ngIf="!isSubmitting">save</mat-icon>
      <mat-spinner *ngIf="isSubmitting" diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
      {{ isSubmitting ? 'Mise à jour...' : 'Enregistrer' }}
    </button>
  </mat-dialog-actions>
</div>
